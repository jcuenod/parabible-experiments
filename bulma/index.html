<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Hello Bulma!</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css">
		<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
		<link rel="stylesheet" href="css/canvi.css">
		<script src="js/canvi.js"></script>
		<style type="text/css">
			html {
				overflow-y: hidden;
			}
			.canvi-navbar {
				z-index: 100 !important;
			}
			.canvi-content {
				position: absolute;
				top: 0;
				left: 0;
				width: 100vw;
				height: 100vh;
				overflow-y: auto;
			}
			.fixednav {
				position: sticky;
				top: 0;
				box-shadow: 0 0 10px #ddd;
			}

			.chapterMenu a {
				width: 2.5em;
				margin: 3px 1px;
			}
			.chapterMenu a:hover {
				background-color: #eee;
			}

			.sidebarThing {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				overflow-x: hidden;
				overflow-y: auto;
			}
			.singlewidth {
				position: absolute;
				width: 100%;
				min-height: 100vh;
				padding: 30px 10px 10px 40px;
				transform: translateX(100%);
				transition: opacity 200ms ease, transform 300ms ease;
			}
			.singlewidth.show {
				transform: translateX(0);
			}
			.singlewidth.hide {
				opacity: 0;
			}
			.hebrewText {
				font-family: SBL Hebrew;
				font-size: xx-large;
				direction: rtl;
			}
			.wbit:hover {
				color: #113;
				cursor: pointer;
			}
			.v {
				position: relative;
				top: -1em;
				padding: 2px;
				font-weight: bold;
				font-size: small;
				color: red;
			}

			.morphbox {
				opacity: 0;
				transition: opacity 600ms ease;
				max-height: 80vh;
				overflow-y: auto;
				position: sticky;
				top: 20vh
			}
			.morphbox.show {
				opacity: 1;
			}

			.activewbit {
				color: #ff4f00;
			}
		</style>
	</head>
	<body>

    	
    <div class="canvi-navbar">
    	<div class="sidebarThing">
    		<div class="singlewidth bookMenu show">
				<aside class="menu">
					<p class="menu-label">
					Select Book
					</p>
					<ul class="menu-list">
						<li><a href=#>Genesis</a></li>
						<li><a href=#>Exodus</a></li>
						<li><a href=#>Leviticus</a></li>
						<li><a href=#>Numbers</a></li>
						<li><a href=#>Deuteronomy</a></li>
						<li><a href=#>Joshua</a></li>
						<li><a href=#>Judges</a></li>
						<li><a href=#>Ruth</a></li>
						<li><a href=#>1 Samuel</a></li>
						<li><a href=#>2 Samuel</a></li>
						<li><a href=#>1 Kings</a></li>
						<li><a href=#>2 Kings</a></li>
						<li><a href=#>1 Chronicles</a></li>
						<li><a href=#>2 Chronicles</a></li>
						<li><a href=#>Ezra</a></li>
						<li><a href=#>Nehemiah</a></li>
						<li><a href=#>Esther</a></li>
						<li><a href=#>Job</a></li>
					</ul>
				</aside>
    		</div>
    		<div class="singlewidth chapterMenu" style="padding-right: 30px">
				<aside class="menu">
					<p class="menu-label">
					Select Chapter
					</p>
					<p>
						<a href="#" class="button is-small">1</a>
						<a href="#" class="button is-small">2</a>
						<a href="#" class="button is-small">3</a>
						<a href="#" class="button is-small">4</a>
						<a href="#" class="button is-small">5</a>
						<a href="#" class="button is-small">6</a>
						<a href="#" class="button is-small">7</a>
						<a href="#" class="button is-small">8</a>
						<a href="#" class="button is-small">9</a>
						<a href="#" class="button is-small">10</a>

						<a href="#" class="button is-small">11</a>
						<a href="#" class="button is-small">12</a>
						<a href="#" class="button is-small">13</a>
						<a href="#" class="button is-small">14</a>
						<a href="#" class="button is-small">15</a>
						<a href="#" class="button is-small">16</a>
						<a href="#" class="button is-small">17</a>
						<a href="#" class="button is-small">18</a>
						<a href="#" class="button is-small">19</a>
						<a href="#" class="button is-small">20</a>

						<a href="#" class="button is-small">21</a>
						<a href="#" class="button is-small">22</a>
						<a href="#" class="button is-small">23</a>
						<a href="#" class="button is-small">24</a>
						<a href="#" class="button is-small">25</a>
						<a href="#" class="button is-small">26</a>
						<a href="#" class="button is-small">27</a>
						<a href="#" class="button is-small">28</a>
						<a href="#" class="button is-small">29</a>
						<a href="#" class="button is-small">30</a>

						<a href="#" class="button is-small">31</a>
						<a href="#" class="button is-small">32</a>
						<a href="#" class="button is-small">33</a>
						<a href="#" class="button is-small">34</a>
						<a href="#" class="button is-small">35</a>
						<a href="#" class="button is-small">36</a>
						<a href="#" class="button is-small">37</a>
						<a href="#" class="button is-small">38</a>
						<a href="#" class="button is-small">39</a>
						<a href="#" class="button is-small">40</a>

						<a href="#" class="button is-small">41</a>
						<a href="#" class="button is-small">42</a>
						<a href="#" class="button is-small">43</a>
						<a href="#" class="button is-small">44</a>
						<a href="#" class="button is-small">45</a>
						<a href="#" class="button is-small">46</a>
						<a href="#" class="button is-small">47</a>
						<a href="#" class="button is-small">48</a>
						<a href="#" class="button is-small">49</a>
						<a href="#" class="button is-small">50</a>
					</p>

					<a class="button is-danger is-outlined" style="position: absolute; top: 5px; right: 5px;">
						<span class="icon is-small">
							<i class="fas fa-times"></i>
						</span>
					</a>
				</aside>
    		</div>
    	</div>
    </div>
    <div class="canvi-content" style="min-height: 100vh">
    	<nav class="navbar fixednav" role="navigation" aria-label="main navigation">
			<div class="navbar-brand">
				<a class="navbar-item" href="https://parabible.com">
					<img src="https://parabible.com/images/parabible-32.png" width="28" height="28">
				</a>

				<a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
				</a>
			</div>

			<div class="navbar-menu">
				<div class="navbar-start">
					<a class="navbar-item openSidebar" onclick="openMenu()">
						Genesis 1
					</a>
				</div>
				<!-- <div class="navbar-end">
					<div class="navbar-item">
						<div class="buttons">
							<a class="button is-primary">
								<strong>Sign up</strong>
							</a>
							<a class="button is-light">
								Log in
							</a>
						</div>
					</div>
				</div>
 -->			</div>
		</nav>
		<section class="section">
			<div class="container">
				<div class="columns">
					<div class="column is-2">
						<div class="morphbox"></div>
					</div>
					<div class="column is-8">
						<div class="hebrewText">
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
	<script type="text/javascript">
		const $ = selector => document.querySelector(selector)
		const toggleClass = (target, classname) => target.classList.toggle(classname)
		const $bookMenuElement = $(".bookMenu")
		const $chapterMenuElement = $(".chapterMenu")
		const $morphbox = $(".morphbox")

		const state = {
			reference: { book: null, chapter: null },
			morphbox: false,
			activeWid: -1
		}
		const sidebarIntention = { book: null, chapter: null}


		const wbit = (b) => `<span class="wbit" data-wid=${b.wid}>${b.word}</span>${b.trailer}`
		const word = (w) => `<span>${w.map(b => wbit(b)).join("")}</span>`
		const verse = (v, n) => `<span><span class="v">${n}</span>${v.map(w => word(w)).join("")}</span>`

		const navigate = (where) => {
			const payload = {
				"reference": where,
				"texts":["wlc","net"]
			}
			fetch("https://parabible.com/api/chapter-text", {
				method: "POST",
				headers: {
					"content-type": "application/json; charset=utf-8"
				},
				body: JSON.stringify(payload),
			}).then(response => {
				return response.json()
			}).then(response => {
				const rids = Object.keys(response.text)
				const wlc = rids.map(rid => verse(response.text[rid].wlc, rid % 1000)).join("")
				$(".hebrewText").innerHTML = wlc
				state.reference = response.reference
				$(".openSidebar").textContent = state.reference.book + " " + state.reference.chapter
			})
		}


		const morphContent = (morph) => {
			const rows = Object.keys(morph)
			const filteredRows = rows.filter(r => true)
			const tableRows = filteredRows.map(key => `<tr><th>${key}</th><td>${morph[key]}</td></tr>`).join("")
			return `<table class="table is-hoverable is-narrow is-fullwidth">${tableRows}</table>`
		}


		const canvi = new Canvi({ pushContent: false })
		const openMenu = () => { canvi.open() }

		const showMorphbox = () => {
			state.morphbox = true
			const parent = $morphbox.closest(".is-2")
			parent.classList.remove("is-2")
			parent.classList.add("is-3")
			$morphbox.classList.add("show")
		}
		const resetSidebar = () => {
			toggleClass($chapterMenuElement, "show")
			toggleClass($bookMenuElement, "hide")
		}
		const delayedResetSidebar = () => setTimeout(resetSidebar, 250)
		document.addEventListener("click", (e) => {
			if (e.target.matches(".bookMenu a")) {
				toggleClass($chapterMenuElement, "show")
				toggleClass($bookMenuElement, "hide")
				sidebarIntention.book = e.target.textContent
			}
			else if (e.target.matches(".chapterMenu a")) {
				delayedResetSidebar()
				canvi.close()
				sidebarIntention.chapter = +e.target.textContent
				navigate(sidebarIntention)
			}
			else if (e.target.matches(".wbit")) {
				const wid = +e.target.dataset.wid
				const payload = { wid }
				fetch("https://parabible.com/api/word-lookup", {
					method: "POST",
					headers: {
						"content-type": "application/json; charset=utf-8"
					},
					body: JSON.stringify(payload),
				}).then(response => {
					return response.json()
				}).then(response => {
					state.activeWid = wid
					const activeWbit = $(".activewbit")
					if (activeWbit) {
						activeWbit.classList.remove("activewbit")
					}
					$(`.wbit[data-wid="${wid}"]`).classList.add("activewbit")
					$morphbox.innerHTML = morphContent(response.results)
					if (!state.morphbox) {
						showMorphbox()
					}
				})
			}
		})
	</script>
	</body>
</html>